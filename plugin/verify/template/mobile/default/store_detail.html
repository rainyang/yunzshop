{template 'common/header'}
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no" />
    <title></title>
    <link href="../addons/sz_yi/plugin/verify/template/mobile/default/static/css/style.fn.min.css" rel="stylesheet">
    <script src="../addons/sz_yi/plugin/verify/template/mobile/default/static/js/apps.js"></script>
</head>
<body class="b-body">
    <div id="container"></div>
</body>
</html>
<script type="text/html" id="tpl_container">
    <div class="b-detail">
        <div class="head">
            <img src="<%store.thumb%>"/>
                    <div class="name"><%store.storename%>
                    {if p('cashier')}
                        <%if store.cashierid > 0%>
                        <a class="yhBut" href="{php echo $this->createPluginMobileUrl("cashier/order_confirm")}&sid=<%store.cashierid%>">优惠买单</a>
                        <%/if%>
                    {/if}
                    </div>
            <div class="pj">
                <i class="iconfontlw <%if store.level >= 1 %>in<%/if%>">&#xe6bc;</i>
                <i class="iconfontlw <%if store.level >= 2 %>in<%/if%>">&#xe6bc;</i>
                <i class="iconfontlw <%if store.level >= 3 %>in<%/if%>">&#xe6bc;</i>
                <i class="iconfontlw <%if store.level >= 4 %>in<%/if%>">&#xe6bc;</i>
                <i class="iconfontlw <%if store.level >= 5 %>in<%/if%>">&#xe6bc;</i>
                <span class="s1">￥<%store.singleprice%>/人</span>
                <span class="s2">人均：￥<%store.singleprice%></span>
            </div>
            <div class="dz">
                <a href="http://api.map.baidu.com/marker?location=<%store.lat%>,<%store.lng%>&title=<%store.storename%>&name=<%store.storename%>&content=<%store.address%>&output=html">
                    <div class="l"><i class="iconfontlw">&#xe611;</i></div>
                    <div class="c"><%store.province%>-<%store.city%>-<%store.area%>-<%store.address%></div>
                </a>

                <div class="r"><a href="tel:<%store.tel%>"><i class="iconfontlw">&#xe6ed;</i></a></div>

            </div>
        </div>
        <div class="b-br"></div>
        <div class="list">
            <%each store_goods as grow%>
            <div class="t2">
                <div class="img">
                    <img src="<%grow.thumb%>"/>
                </div>
                <div class="r">
                    <div class="s1">已售<%grow.sales%></div>
                    <div class="s2" onclick="location.href='{php echo $this->createMobileUrl('shop/detail')}&id=<%grow.id%>'">购买</div>
                </div>
                <div class="c">
                    <div class="p1"><%grow.title%></div>
                    <div class="p2">
                        <span class="s1">￥<%grow.marketprice%></span>
                        <span class="s2">门市价:￥<%grow.productprice%></span>
                    </div>
                </div>
            </div>
            <%/each%>
        </div>
        <div class="b-br"></div>
        <div class="more">
            <div class="h">
                更多信息
            </div>
            <div class="m">
                <%store.info%>
            </div>
        </div>
        <div class="b-br"></div>

    </div>

    <div class="con" id="con_3" ><div id='comment_container'></div></div>

    <div class="b-list">
        <div class="title">
            <div class="x">
                <span>附近推荐</span>
            </div>
        </div>
        <div class="main">
            <ul>
                <%each near_goods as nrow%>
                <li>
                    <a href="{php echo $this->createMobileUrl('shop/detail')}&id=<%nrow.id%>">
                        <div class="img">
                            <img src="<%nrow.thumb%>"/>
                        </div>
                        <div class="text">
                            <div class="t1">
                                <div class="s1"><%nrow.title%></div>
                                <%if nrow.km == 1%>
                                <div class="s2"><%nrow.distance%>km</div>
                                <%else%>
                                <div class="s2"><%nrow.distance%>m</div>
                                <%/if%>
                            </div>
                            <div class="t2"><%nrow.storename%>(<%nrow.address%>)</div>
                            <div class="t3">
                                <span class="s1">￥<%nrow.marketprice%></span>
                                <span class="s2">门市价:￥<%nrow.productprice%></span>
                                <div class="s3">已售<%nrow.sales%></div>
                            </div>
                        </div>
                    </a>
                </li>
                <%/each%>
            </ul>
        </div>
    </div>
    <div class="b-br"></div>
    <div class="b-list">
        <div class="title">
            <div class="x">
                <span>推荐商家</span>
            </div>
        </div>
        <div class="main">
            <ul>
                <%each store_list as srow%>
                <li>
                    <a href="{php echo $this->createPluginMobileUrl('verify/store_detail')}&id=<%srow.id%>">
                        <div class="img">
                            <img src="<%srow.thumb%>"/>
                        </div>
                        <div class="text">
                            <div class="t1">
                                <div class="s1"><%srow.storename%></div>
                                <%if srow.km == 1%>
                                <div class="s2"><%srow.distance%>km</div>
                                <%else%>
                                <div class="s2"><%srow.distance%>m</div>
                                <%/if%>
                            </div>
                            <div class="t2"><%srow.name%></div>
                            <div class="t3">
                                <span class="s1">￥<%srow.singleprice%>/人</span>
                                <div class="s3"><%srow.street%></div>
                            </div>
                        </div>
                    </a>
                </li>
                <%/each%>
            </ul>
        </div>
    </div>
</script>
<script id='tpl_comment' type='text/html'>
    <%each list as comment%>
    <div class='comment'>
        <div class='info'>
            <div class='head'><img src='<%comment.headimgurl%>' style='width:30px;height:30px;' /></div>
            <div class='nickname'><div class='inner'><%comment.nickname%></div></div>
            <div class='level'>
                <%if comment.level>=1%><i class='fa fa-star'></i><%else%><i class='fa fa-star-o'></i><%/if%>
                <%if comment.level>=2%><i class='fa fa-star'></i><%else%><i class='fa fa-star-o'></i><%/if%>
                <%if comment.level>=3%><i class='fa fa-star'></i><%else%><i class='fa fa-star-o'></i><%/if%>
                <%if comment.level>=4%><i class='fa fa-star'></i><%else%><i class='fa fa-star-o'></i><%/if%>
                <%if comment.level>=5%><i class='fa fa-star'></i><%else%><i class='fa fa-star-o'></i><%/if%>
            </div>
        </div>
        <div class='content'><%comment.content%></div>
        <%if comment.images.length>0%>
        <div class='imgs'>
            <%each comment.images as img%><img src='<%img%>' style='width:30px;height:30px;' /><%/each%>
        </div>
        <%/if%>
        <%if comment.reply_content!=''%>
        <div class='content' style='margin-top:5px;'><span style='color:#ff6600'>[回复]</span><%comment.reply_content%></div>
        <%if comment.reply_images.length>0%>
        <div class='imgs'>
            <%each comment.reply_images as img%><img src='<%img%>' style='width:30px;height:30px;' /><%/each%>
        </div>
        <%/if%>
        <%/if%>

        <%if comment.append_content!=''%>
        <div class='content' style='margin-top:5px;'><span style='color:#ff6600'>[追加]</span><%comment.append_content%></div>
        <%if comment.append_images.length>0%>
        <div class='imgs'>
            <%each comment.append_images as img%><img src='<%img%>' style='width:30px;height:30px;' /><%/each%>
        </div>
        <%/if%>
        <%/if%>

        <%if comment.append_reply_content!=''%>
        <div class='content' style='margin-top:5px;'><span style='color:#ff6600'>[回复]</span><%comment.append_reply_content%></div>
        <%if comment.append_reply_images.length>0%>
        <div class='imgs'>
            <%each comment.append_reply_images as img%><img src='<%img%>' style='width:30px;height:30px;' /><%/each%>
        </div>
        <%/if%>
        <%/if%>
        <div class='time'><%comment.createtime%></div>
    </div>
    <%/each%>
</script>
<script language="JavaScript">
    require(['core','tpl'], function (core,tpl) {
        core.pjson('verify/store_detail', {id:"{$_GPC['id']}"}, function (json) {
            $('#container').html(tpl('tpl_container', json.result));
            var page = 1;
            core.json('shop/util',{op:'comment', page:page,storeid:"{$_GPC['id']}"},function(cjson){
                if(cjson.result.list.length<=0){
                    $('#comment_container').html('暂时没有任何评价');
                    return;
                }
                $('#comment_container').html( tpl('tpl_comment',cjson.result));
                bindCommentImages();
                var loaded = false;
                var stop=true;
                $(window).scroll(function(){
                    if(loaded){
                        return;
                    }
                    totalheight = parseFloat($(window).height()) + parseFloat($(window).scrollTop());
                    if($(document).height() <= totalheight){

                        if(stop==true){
                            stop=false;
                            $('#comment_container').append('<div id="comment_loading"><i class="fa fa-spinner fa-spin"></i> 正在加载...</div>');
                            page++;
                            core.json('shop/util', {op:'comment',page:page,storeid:"{$_GPC['id']}"}, function(morejson) {
                                stop = true;
                                $('#comment_loading').remove();
                                $("#comment_container").append(tpl('tpl_comment', morejson.result));
                                bindCommentImages();
                                if (morejson.result.list.length <morejson.result.pagesize) {

                                    $("#comment_container").append('<div id="comment_loading">已经加载完全部评价</div>');
                                    loaded = true;
                                    $(window).scroll = null;
                                    return;
                                }
                            },true);
                        }
                    }
                });
            });
        });
        function bindCommentImages(){
            var z = [];
            $(".comment .imgs img").each(function() {
                z.push($(this).attr("src"));
            });
            var current;
            if (isWX) {
                $(".comment .imgs  img").click(function(e) {
                    e.preventDefault();
                    var startingIndex = $(".comment .imgs  img").index($(e.currentTarget));
                    var current = null;
                    $(".comment .imgs  img").each(function(B, A) {
                        if (B === startingIndex) {
                            current = $(A).attr("src");
                        }
                    });
                    WeixinJSBridge.invoke("imagePreview", {
                        current: current,
                        urls: z
                    });
                });
            }
        }
    });
</script>
{php $show_footer=true}
{template 'common/footer'}