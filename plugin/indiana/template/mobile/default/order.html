{template 'common/header'}
<title>{$title}</title>
<style type="text/css">
    body {margin:0px; background:#efefef; -moz-appearance:none; -webkit-appearance: none;}
    .order_topbar {height:44px; width:100%; background:#fff; border-bottom:1px solid #e3e3e3;}
    .order_topbar .nav {height:44px; {if $operation == 'display'}width:25%;{else}width:50%;{/if} line-height:44px;cursor: pointer;
	text-align:center; font-size:14px; float:left; color:#666;}
    .order_topbar .on {height:42px; color:#f15353; border-bottom:2px solid #f15353;}

    .order_main {height:auto; width:94%; background:#fff; padding:0px 3%; margin-top:16px; border-bottom:1px solid #e2e2e2; border-top:1px solid #e2e2e2;}
   
    .order_main .good {height:70px; width:100%; padding:10px 0px; border-bottom:1px solid #eaeaea;}
    .order_main .good .img {height:70px; width:70px; float:left;}
    .order_main .good  .img img {height:100%; width:100%;}
    .order_main .good  .info {width:90%;float:left; margin-left:-50px;margin-right:-60px;}
    .order_main .good .info .inner { margin-left:60px;margin-right:0px; }
    .order_main .good .info .inner .name {height:35px; width:100%; float:left; font-size:12px; color:#555;overflow:hidden;}
    .order_main .good .info .inner .option {height:18px; width:100%; float:left; font-size:12px; color:#888;overflow:hidden;word-break: break-all}
    .order_main .good span { color:#666;}

    .order_main .sub {height:40px; width:100%;}
    .order_main .sub1 {height:30px; width:auto; padding:0px 3px; border:1px solid #ff771b; float:right; border-radius:5px; line-height:30px; font-size:14px; margin: 4px 0 10px 5px !important; color:#fff; background:#ff771b;}
    
    .order_no {height:40px; width:100%;  padding-top:10px; margin:50px 0px;}

    .order_no {height:100px; width:100%; margin:50px 0px 60px; color:#BFBFBF; font-size:12px; text-align:center;}
    .order_no_menu {height:40px; width:100%; text-align:center;}
    .order_no_nav {height:34px;padding:6px 20px;background:#eee; border:1px solid #d4d4d4; border-radius:5px; text-align:center; line-height:34px; color:#666;font-size: 16px}
    #order_loading { width:94%;padding:10px;color:#666;text-align: center;}
.no-icon .fa{ font-size: 80px;padding-bottom: 20px}
.no-icon span{color: #929292;line-height: 20px;font-size: 14px}

.progress-bar { margin-bottom: 5px; position: relative; width: 100%; height: 8px; z-index: 2; -webkit-border-radius: 4px; border-radius: 4px; font-size: 0; line-height: 0; background: #e04512; background: -webkit-gradient(linear,left top, right top,from(#fcc150),to(#e04512)); background: -webkit-linear-gradient(left,#fcc150,#e04512); background: linear-gradient(to right,#fcc150,#e04512);
}
.bg { display: block; width: 101%; height: 8px; position: absolute; z-index: 3; background-color: #d8d8d8; right: -1px; -webkit-border-radius: 0 4px 4px 0; border-radius: 0 4px 4px 0;
}
.other {border-top:1px dashed #f3f3f3;  height:34px; width:100%;  line-height:34px; font-size:12px; color:#999;}
</style>
<div id='container'></div>
<script id='tpl_order_list' type='text/html'>
    <div class="page_topbar">
    	<a href="javascript:;" class="back" onclick="location.href='{php echo $this->createMobileUrl('member')}'"><i class="fa fa-angle-left"></i></a>
    	<div class="title">{$title}</div>
	</div>
	{if $operation == 'display'}
	    <div class="order_topbar">
			<div class="nav {if $_GPC['status']==''}on{/if}" data-status="0">参与成功</div>
			<div class="nav {if $_GPC['status']=='1'}on{/if}" data-status="1">正在进行</div>
	        <div class="nav {if $_GPC['status']=='0'}on{/if}" data-status="2">即将揭晓</div>
	        <div class="nav {if $_GPC['status']=='2'}on{/if}" data-status="3">已揭晓</div>
	    </div>
    {/if}
    <div id='order_container'></div>
</script>
<script id='tpl_order' type='text/html'>
    <%each list as order%>
    	<div class="order_main" data-orderid="<%order.id%>">
			<%each order.goods as g%>      
				<div class="good">
				    <div class="img" ><img src="<%g.thumb%>"/></div>
				    <div class='info'>
				        <div class='inner'>
				            <div class="name" ><%g.title%>
				            </div>
				            <div class='option'>期号：<%order.period_num%></div> 
				            <div class='option'>
				            	我参与：<span style="color: #f15353;"><%if order.status == 3%><%order.canyurenshu%><%else%><%order.count%><%/if%></span>人次    
				            	<span style="color: rgb(53, 85, 224);padding-left: 10px;" onclick="location.href='{php echo $this->createPluginMobileUrl('indiana/info')}&periodnum=<%order.period_num%>'"> 查看详情</span>
				            </div>      
				        </div>
				    </div>
				</div>
			<%/each%>
	        <div class="sub">
	        <%if order.status == 1%>
	        	<div style="width: 70%; float: left; line-height: 40px;">
					<div class="other" style="height: 24px;line-height: 24px;">
						<span>总需：<%order.zong_codes%></span>
						<span style="float: right;text-align: right;">剩余：<%order.shengyu_codes%></span>
					</div>
			        <div class="progress-bar" >
			            <span class="bg" style="width:<%order.shengyu%>%"></span>
			        </div>
	        	</div>
	           	<div style="width: 30%; float: right;">
	           		<span class="sub1" onclick="location.href='{php echo $this->createMobileUrl('shop/detail')}&id=<%order.goodsid%>&periodnum=<%order.period_num%>&indiana=1'">追加</span>
	           	</div>
	        <%else if order.status == 2%>
	        	<div style="width: 70%; float: left; line-height: 40px;">
					<div class="other" style="height: 24px;line-height: 24px;">
						<span>总需：<%order.zong_codes%></span>
						<span style="float: right;text-align: right;">剩余：<%order.shengyu_codes%></span>
					</div>
			        <div class="progress-bar" >
			            <span class="bg" style="width:<%order.shengyu%>%"></span>
			        </div>
	        	</div>
	           	<div style="width: 30%; float: right;">
	           		<span class="sub1" onclick="location.href='{php echo $this->createMobileUrl('shop/detail')}&id=<%order.goodsid%>&periodnum=<%order.period_num%>&indiana=1'">查看开奖</span>
	           	</div>
	        <%else if order.status == 3%>
	        	<div style="width: 54%; float: left; line-height: 40px;">
					<div class="other" style="height: 36px;line-height: 36px;overflow: hidden;">
						<span>获奖者：<%order.nickname%></span>
					</div>
	        	</div>
	           	<div style="width: 46%; float: right;">
	           	<%if order.next_phase%>
	           		<span class="sub1" onclick="location.href='{php echo $this->createMobileUrl('shop/detail')}&id=<%order.next_phase.goodsid%>&periodnum=<%order.next_phase.period_num%>&indiana=1'">再次购买</span>
	           	<%/if%>
	           		<span class="sub1" onclick="location.href='{php echo $this->createMobileUrl('shop/detail')}&id=<%order.goodsid%>&periodnum=<%order.period_num%>&indiana=1'">计算详情</span>
	           	</div>

	        <%/if%>
	        </div>
	    </div>
    <%/each%>
</script>

<script id='tpl_empty' type='text/html'>
    <div class="order_no no-icon"><i class="fa fa-file-text-o"></i><br><span>您还没有相关的夺宝记录哦~</span><br>可以去看看哪些想买的</div>
    <div class="order_no_menu">
        <span class="order_no_nav"  onclick="location.href='{php echo $this->createPluginMobileUrl('indiana/goods')}'">随便逛逛</span>
    </div>
</script>

<script language='javascript'>
	var page = 1;
	var status = '0';
	require(['tpl', 'core'], function(tpl, core) {
		function getList(status) {
			core.pjson('indiana/order', {page:page, status:status, op: '{$operation}'}, function(json) {
			    $("#container").html(tpl('tpl_order_list'));
				$('.nav').removeClass('on');
                $('.nav[data-status=' + status + ']').addClass('on');

			    if (json.result.list.length <= 0) {
			        $("#order_container").html(tpl('tpl_empty'));
			        return;
			    }
			    $("#order_container").html(tpl('tpl_order', json.result));
			    	var loaded = false;
			      	var stop=true; 
			      	$(window).scroll(function(){ 
						if(loaded){
						  return;
						}
			            totalheight = parseFloat($(window).height()) + parseFloat($(window).scrollTop()); 
			            if($(document).height() <= totalheight){ 
			                if(stop==true){ 
			                    stop=false; 
			                    $('#order_container').append('<div id="order_loading"><i class="fa fa-spinner fa-spin"></i> 正在加载...</div>');
			                    page++;
			                    core.pjson('indiana/order', {page:page, status: status, op: '{$operation}'}, function(morejson) {  
			                        stop = true;
			                        $('#order_loading').remove();
			                        $("#order_container").append(tpl('tpl_order', morejson.result));
			                        if (morejson.result.list.length <morejson.result.pagesize) {
			                            $('#order_container').append('<div id="order_loading">已经加载全部夺宝记录</div>');
			                            loaded = true;
			                            return;
			                        }
			                    },true); 
			                } 
			            } 
			        });
			}, true);
		}
	    // $('.nav').unbind('click').click(function () {
	    $(document).on('click','.nav',function () {
	    	page = 1;
	        status = $(this).data('status');
			getList(status);
	    });
		getList(status);
	});
</script>
{php $show_footer = true}
{template 'common/footer'}
